<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Members and Sample Points Map</title>
    <style>
        #map {
            width: 70vw;
            height: 70vh;
        }
        #info {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            display: none;
        }
        #info h3 {
            margin: 0 0 10px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
</head>
<body>
    <h1>成员与样点地图</h1>
    <div id="map"></div>
    <div id="info">
        <h3>信息：</h3>
        <p id="content"></p>
    </div>

    <script>
        var mapChart = echarts.init(document.getElementById('map'));
        var memberData = [];
        var provinceMemberCount = {};
        var sampleData = [];

        // 加载成员数据和样点数据
        Promise.all([
            fetch('map.json').then(response => response.json()),  // 地图数据
            fetch('member.json').then(response => response.json()),  // 成员数据
            fetch('samples.json').then(response => response.json())  // 样点数据
        ]).then(([geoJson, members, samples]) => {
            console.log('Loaded GeoJSON data:', geoJson);
            echarts.registerMap('china', geoJson);
            console.log('China map registered successfully');

            memberData = members;
            sampleData = samples;
            console.log('Loaded member data:', memberData);
            console.log('Loaded sample data:', sampleData);

            // 统计每个省份的成员数量
            memberData.forEach(member => {
                if (provinceMemberCount[member.province]) {
                    provinceMemberCount[member.province]++;
                } else {
                    provinceMemberCount[member.province] = 1;
                }
            });

            // 手动为不同类型的样点指定颜色
            var colorMapping = {
                '类型A': '#FF0000', // 红色
                '类型B': '#00FF00', // 绿色
                '类型C': '#0000FF'  // 蓝色
            };

            var option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        // 判断是否点击省份还是样点
                        if (params.seriesType === 'scatter') {
                            var sample = params.data;
                            return `名称: ${sample.name}<br>类型: ${sample.type}<br>描述: ${sample.description}`;
                        } else {
                            var province = params.name;
                            var count = provinceMemberCount[province] || 0;
                            return province + ': ' + count + ' 名成员';
                        }
                    }
                },
                visualMap: {
                    min: 0,
                    max: 5, // 调整为实际成员数量的最大值
                    left: 'left',
                    top: 'bottom',
                    text: ['多', '少'],
                    calculable: true,
                    inRange: {
                        color: ['#e0ffff', '#006edd']
                    }
                },
                geo: {
                    map: 'china',
                    roam: true,  // 允许放大缩小以及拖动
                    label: {
                        show: true
                    },
                    scaleLimit: {
                        min: 1,
                        max: 10
                    }
                },
                series: [
                    {
                        name: '成员分布',
                        type: 'map',
                        map: 'china',
                        geoIndex: 0,
                        label: {
                            show: true
                        },
                        roam: true,  // 允许地图内容跟随放大缩小
                        data: Object.keys(provinceMemberCount).map(province => ({
                            name: province,
                            value: provinceMemberCount[province]
                        }))
                    },
                    {
                        name: '样点',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        symbolSize: 10,
                        itemStyle: {
                            color: function (params) {
                                // 根据类别映射颜色
                                return colorMapping[params.data.type];
                            }
                        },
                        data: sampleData.map(sample => ({
                            name: sample.name,
                            value: [sample.longitude, sample.latitude],  // 经纬度
                            description: sample.description,
                            type: sample.type
                        })),
                        encode: {
                            tooltip: [0, 1]
                        }
                    }
                ]
            };

            console.log('Map option:', option);
            mapChart.setOption(option);

            // 点击事件处理
            mapChart.on('click', function (params) {
                if (params.seriesType === 'scatter') {
                    // 点击样点时，显示样点信息
                    var sample = params.data;
                    document.getElementById('content').innerHTML = `样点名称: ${sample.name}<br>类型: ${sample.type}<br>描述: ${sample.description}`;
                    document.getElementById('info').style.display = 'block';
                } else if (params.seriesType === 'map') {
                    // 点击省份时，显示该省份的成员信息
                    var province = params.name;
                    var membersInProvince = memberData.filter(member => member.province === province);

                    if (membersInProvince.length > 0) {
                        var memberInfo = membersInProvince.map(member => `<strong>${member.name}</strong> - ${member.status}, Email: ${member.email}`).join('<br>');
                        document.getElementById('content').innerHTML = `省份: ${province}<br>成员信息:<br>${memberInfo}`;
                    } else {
                        document.getElementById('content').innerHTML = `省份: ${province}<br>无成员信息`;
                    }
                    document.getElementById('info').style.display = 'block';
                }
            });
        }).catch(error => {
            console.error('Error loading or processing data:', error);
            alert('加载数据时发生错误。请查看控制台以获取更多详细信息。');
        });
    </script>
</body>
</html>
